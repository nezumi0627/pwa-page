<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>PWAåˆ¤å®š</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="/pwa-page/manifest.json" />
</head>
<body>
  <h1>PWAã®åˆ¤å®šçµæœ</h1>

  <p id="appVersion">ã‚¢ãƒ—ãƒªãƒãƒ¼ã‚¸ãƒ§ãƒ³: åˆ¤å®šä¸­</p>
  <p id="cacheName">ã‚­ãƒ£ãƒƒã‚·ãƒ¥å: åˆ¤å®šä¸­</p>
  <p id="https">HTTPS: åˆ¤å®šä¸­</p>
  <p id="manifest">Manifest: åˆ¤å®šä¸­</p>
  <p id="sw">Service Worker: åˆ¤å®šä¸­</p>
  <p id="result">å…¨ä½“æ¡ä»¶: åˆ¤å®šä¸­</p>
  <p id="displayMode">ç¾åœ¨ã®è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰: åˆ¤å®šä¸­</p>

  <button id="updateBtn">ğŸ”„ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å¼·åˆ¶æ›´æ–°</button>
  <p id="updateStatus"></p>

  <h2>ğŸ“¦ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¸€è¦§</h2>
  <ul id="cacheList">èª­ã¿è¾¼ã¿ä¸­...</ul>

  <h2>ğŸ“ åå‰ã‚’å…¥åŠ›</h2>
  <input type="text" id="nameInput" placeholder="åå‰ã‚’å…¥åŠ›" />
  <button id="saveNameBtn">ğŸ’¾ ä¿å­˜</button>
  <p id="savedNameDisplay"></p>

  <script src="/pwa-page/version.js"></script>
  <script src="/pwa-page/name-demo.js"></script>
  <script>
    async function displayCacheKeys() {
      if (!('caches' in window)) return;
      const keys = await caches.keys();
      const list = document.getElementById('cacheList');
      list.innerHTML = '';
      keys.forEach(key => {
        const li = document.createElement('li');
        li.textContent = key;
        list.appendChild(li);
      });
    }

    window.addEventListener('load', () => {
      if (typeof APP_VERSION === 'undefined') {
        document.getElementById('appVersion').textContent = 'ã‚¢ãƒ—ãƒªãƒãƒ¼ã‚¸ãƒ§ãƒ³: âŒ version.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“';
        return;
      }

      const cacheName = 'pwa-cache-' + APP_VERSION;
      document.getElementById('appVersion').textContent = `ã‚¢ãƒ—ãƒªãƒãƒ¼ã‚¸ãƒ§ãƒ³: âœ… ${APP_VERSION}`;
      document.getElementById('cacheName').textContent = `ã‚­ãƒ£ãƒƒã‚·ãƒ¥å: âœ… ${cacheName}`;

      const httpsOK = location.protocol === 'https:' || location.hostname === 'localhost';
      const manifestOK = !!document.querySelector('link[rel="manifest"]');
      const swOK = 'serviceWorker' in navigator;

      document.getElementById('https').textContent = 'HTTPS: ' + (httpsOK ? 'âœ… OK' : 'âŒ NG');
      document.getElementById('manifest').textContent = 'Manifest: ' + (manifestOK ? 'âœ… OK' : 'âŒ NG');
      document.getElementById('sw').textContent = 'Service Worker: ' + (swOK ? 'âœ… OK' : 'âŒ NG');
      document.getElementById('result').textContent = 'å…¨ä½“æ¡ä»¶: ' + (httpsOK && manifestOK && swOK ? 'âœ… æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã™' : 'âŒ ä¸å®Œå…¨ã§ã™');

      if (swOK) {
        navigator.serviceWorker.register('/pwa-page/sw.js')
          .then(registration => {
            if (navigator.serviceWorker.controller) {
              navigator.serviceWorker.controller.postMessage({
                type: 'version',
                version: APP_VERSION
              });
            }

            registration.addEventListener('updatefound', () => {
              const newSW = registration.installing;
              if (newSW) {
                newSW.addEventListener('statechange', e => {
                  if (e.target.state === 'installed') {
                    alert('æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã—ãŸã€‚å†èµ·å‹•ã—ã¦ãã ã•ã„ã€‚');
                  }
                });
              }
            });
          });

        // æ›´æ–°ãƒœã‚¿ãƒ³å‡¦ç†
        document.getElementById('updateBtn').addEventListener('click', () => {
          if (navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({ type: 'force-update' });
            document.getElementById('updateStatus').textContent = 'âš™ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ã‚’é–‹å§‹ã—ã¾ã—ãŸ...';
          } else {
            document.getElementById('updateStatus').textContent = 'âŒ SWã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
          }
        });

        // SWã‹ã‚‰æ›´æ–°å®Œäº†é€šçŸ¥ã‚’å—ã‘å–ã‚‹
        navigator.serviceWorker.addEventListener('message', event => {
          if (event.data === 'update-complete') {
            document.getElementById('updateStatus').textContent = 'âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸ';
            displayCacheKeys(); // æ›´æ–°å¾Œã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å†è¡¨ç¤º
          }
        });
      }

      const getDisplayMode = () => {
        let mode = 'ãƒ–ãƒ©ã‚¦ã‚¶ã‚¿ãƒ–';
        if (window.matchMedia('(display-mode: standalone)').matches) {
          mode = 'PWA (standalone)';
        } else if (navigator.standalone) {
          mode = 'PWA (iOS)';
        }
        document.getElementById('displayMode').textContent = `ç¾åœ¨ã®è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰: âœ… ${mode}`;
      };

      getDisplayMode();
      displayCacheKeys();
    });
  </script>
</body>
</html>
