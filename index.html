<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PWA更新テスト</title>
  <link rel="manifest" href="/pwa-page/manifest.json" />
</head>
<body>
  <h1>PWAバージョン確認</h1>
  <p id="version">バージョン: 読み込み中...</p>
  <p id="displayMode">表示モード: 判定中...</p>
  <p id="updateStatus"></p>
  <button id="updateCheck">更新をチェック</button>

  <script src="/pwa-page/version.js"></script>
  <script>
    document.getElementById('version').textContent = 'バージョン: ' + APP_VERSION;

    function getDisplayMode() {
      let mode = 'ブラウザ表示';
      if (window.matchMedia('(display-mode: standalone)').matches) mode = 'PWA表示';
      else if (navigator.standalone) mode = 'iOS PWA表示';
      document.getElementById('displayMode').textContent = '表示モード: ' + mode;
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/pwa-page/sw.js')
        .then(reg => {
          // バージョンをSWに送信
          if (navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({
              type: 'version',
              version: APP_VERSION
            });
          }

          // 更新通知イベント
          reg.addEventListener('updatefound', () => {
            const newSW = reg.installing;
            if (newSW) {
              newSW.addEventListener('statechange', e => {
                if (e.target.state === 'installed') {
                  alert('新しいバージョンがインストールされました。再起動してください。');
                }
              });
            }
          });

          // 更新ボタン
          document.getElementById('updateCheck').onclick = () => {
            reg.update().then(() => {
              document.getElementById('updateStatus').textContent = '✅ 更新確認を実行しました';
            });
          };
        })
        .catch(err => {
          console.error('SW登録失敗:', err);
        });
    }

    window.addEventListener('load', getDisplayMode);
  </script>
</body>
</html>
